# blink-superdirt

A [blink.cmp](https://github.com/Saghen/blink.cmp) source for SuperDirt/TidalCycles autocompletion in Neovim.

## Features

- Autocomplete SuperDirt samples and synths in `.tidal` files
- Context-aware completion (only suggests in sound contexts like `s "..."`)
- Integrates seamlessly with blink.cmp

## Installation

### Using [lazy.nvim](https://github.com/folke/lazy.nvim)

```lua
{
  "your-username/blink-superdirt",
  dependencies = { "saghen/blink.cmp" },
  config = function()
    require("blink-superdirt").setup({
      -- Optional configuration
      dir = vim.fn.expand("~/.cache/tidal-autocomplete"), -- default
      include_synths = true,  -- default
      include_samples = true, -- default
    })
  end
}
```

Then add the source to your blink.cmp configuration:

```lua
require("blink.cmp").setup({
  sources = {
    providers = {
      -- ... other providers
      superdirt = {
        name = "SuperDirt",
        module = "blink-superdirt.source",
        opts = {}, -- optional, will use defaults from setup()
      },
    },
  },
})
```

Or if you want to create the source directly:

```lua
require("blink.cmp").setup({
  sources = {
    providers = {
      -- ... other providers
      superdirt = require("blink-superdirt").create_source(),
    },
  },
})
```

## Prerequisites

The plugin expects to find SuperDirt sample and synth lists at:
- `~/.cache/tidal-autocomplete/samples.txt` - List of available samples
- `~/.cache/tidal-autocomplete/synths.txt` - List of available synths
- `~/.cache/tidal-autocomplete/synth_params.txt` - Synth parameters with defaults (optional)

These files are automatically generated by SuperDirt when you add the export code to your SuperDirt boot file.

### Setting up SuperDirt Export

Add the following code to your SuperDirt boot file (typically `~/.config/SuperCollider/startup.scd` or wherever you initialize SuperDirt):

```supercollider
// ---- Export SuperDirt names for external autocomplete (samples + synths + params) ----
~exportTidalAC = {
    var dir, samples, synths, tmpIdx, nextCh;  // vars must be at the top

    dir = (Platform.userHomeDir +/+ ".cache/tidal-autocomplete").standardizePath;
    File.mkdir(dir);

    // samples (from SuperDirt's loaded buffers)
    samples = if(~dirt.notNil and: { ~dirt.buffers.notNil }) {
        ~dirt.buffers.keys.asArray.collect(_.asString).sort
    } { [] };

    File.use(dir +/+ "samples.txt", "w", { |f|
        samples.do { |n| f.write(n); f.nl };
    });

    // synths (from SynthDescLib), filter internals and collapse variant suffixes
    synths = SynthDescLib.global.synthDescs.keys.asArray
        .collect(_.asString)
        .reject({ |name| name.beginsWith("dirt_") or: { ["dirt_out","dirt_gate"].includes(name) } })
        .collect({ |name|
            tmpIdx = name.find("_");
            if(tmpIdx.notNil) {
                nextCh = name.at(tmpIdx + 1).asString;
                if((nextCh != "l") and: (nextCh != "s")) {
                    name = name.copyRange(0, tmpIdx - 1);
                };
            };
            name
        })
        .as(Set).asArray.sort;

    File.use(dir +/+ "synths.txt", "w", { |f|
        synths.do { |n| f.write(n); f.nl };
    });

    // NEW: export default params for each synth as "name -> param:default â€¦"
    File.use(dir +/+ "synth_params.txt", "w", { |f|
        synths.do { |nm|
            var d;  // declare at the start of this block
            d = SynthDescLib.match(nm.asSymbol);
            if(d.notNil) {
                f.write(nm ++ " ->");
                d.controls.do { |ctr|
                    if(ctr.name != \out) {
                        f.write(" " ++ ctr.name.asString ++ ":" ++ ctr.defaultValue.asString);
                    }
                };
                f.nl;
            };
        };
    });

    ("[Tidal AC] wrote " ++ samples.size ++ " samples & " ++ synths.size
      ++ " synths (with params) to " ++ dir).postln;
};

// run it a moment after boot so loads finish (or call ~exportTidalAC.value manually)
AppClock.sched(3.0, { ~exportTidalAC.value; nil });
```

This code will:
1. Create the `~/.cache/tidal-autocomplete` directory if it doesn't exist
2. Export all loaded SuperDirt sample names to `samples.txt`
3. Export all available synth names to `synths.txt` (filtering out internal SuperDirt synths)
4. Export synth parameters with their default values to `synth_params.txt`
5. Run automatically 3 seconds after SuperDirt boots to ensure everything is loaded

You can also manually trigger the export at any time by evaluating `~exportTidalAC.value` in SuperCollider.

The export files are:
- `samples.txt` - One sample name per line
- `synths.txt` - One synth name per line
- `synth_params.txt` - Each line contains synth name and parameters in format: `synthname -> param1:default1 param2:default2 ...`

The plugin uses these files to provide context-aware autocomplete suggestions with parameter hints for synths.

## Configuration

```lua
require("blink-superdirt").setup({
  -- Directory containing samples.txt and synths.txt
  dir = vim.fn.expand("~/.cache/tidal-autocomplete"),
  
  -- Whether to include synths in completions
  include_synths = true,
  
  -- Whether to include samples in completions  
  include_samples = true,
})
```

## License

MIT